<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>파티 상세 페이지</title>
  <link rel="stylesheet" href="./VertScreen_mainStyle.css" />
  <link rel="stylesheet" href="./party-make01.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=pq3dgwzbry"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>
<body>
  <!--header-->
  <header class="site-header">
    <div class="nav-wrap">
      <div class="brand">
        <a href="./vertscreen_main.html">
        <img src="./VertScreen_logo.png" alt="VertScreen Logo">
        </a>
      </div>
      <nav class="nav">
        <a href="./vertscreen_advertlist.html">광고 종류</a>
        <a href="./vertscreen_brand.html">브랜드 가치</a>
        <a href="./party-make01.html">파티 모집</a>
        <a href="#">광고 제안</a>
        <a href="./review.html" id="reviewLink">리뷰 게시판</a>
      </nav>
      <div class="spacer"></div>
      <div class="actions" id="authArea">
        <a href="login.html" class="btn">로그인</a>
        <a href="login.html" class="btn primary">회원가입</a>
      </div>
      <div class="profile" id="profile">
        <div class="avatar" id="avatar">U</div>
        <div class="dropdown" id="dropdown">
          <div style="padding:12px;color:var(--muted)" id="welcomeMsg">사용자님 환영합니다!</div>
          <a href="./myPage.html">마이페이지</a>
          <button onclick="logout()">로그아웃</button>
        </div>
      </div>
    </div>
  </header>
  <!--header end-->

  <!-- 지도 -->
  <div class="map" id="detail-map" style="width:1220px;height:400px;margin:20px auto;border-radius:8px;"></div>

  <br> 

  <!-- 선택한 광고 정보 -->
  <h2>선택한 광고 상세 정보</h2>
  <div class="party-ad">
    <div>
      <img id="detail-map-img" src="./no_image.png" alt="선택된 광고 이미지" style="width:600px;height:400px;border-radius:8px;">
    </div>
    <div class="info-text-wrap">
      <p id="detail-poster">광고판명 : -</p>
      <p id="detail-text">설명 : -</p>
      <p id="detail-amount">가격 : -</p>
      <p id="detail-date">선택한 날짜 : -</p>
      <p id="detail-headcount">인원 수 : -</p>
      <p id="detail-peramount">1인당 예상 결제 금액 : -</p>
    </div>
  </div>

  <br>

  <!-- 업로드 이미지 & 제목/내용 -->
  <h2>파티 내용</h2>
  <div class="party-ad">
    <div>
      <img id="detail-upload-img" src="./no_image.png" alt="업로드 이미지" style="width:600px;height:400px;border-radius:8px;">
    </div>
    <div class="info-text-wrap">
      <h3 id="detail-title">제목 : -</h3>
      <p id="detail-content">내용 : -</p>
    </div>
  </div>
  <br>
  <!-- 파티원 수 및 결제 금액 -->
  <h2>파티원 수 및 결제 금액</h2>
  <div class="party-ad" id="payment-status">
  </div>
  <!-- 진행률 바 -->
    <div class="progress-wrap">
      <div class="progress-label">
        <span id="progress-text">진행률 : 0%</span>
        <span id="remain-text">남은 금액: 0 원</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

  <div class="pnc-btn">
  <button class="make-party" onclick="joinParty()">참여하기</button>
  <a href="./party-board.html"><button class="cancel">취소하기</button></a>
</div>
  

  <script>
// 로컬스토리지 저장값 불러오기
  let partyData = JSON.parse(localStorage.getItem("partyData"));
  /* 프로필 */
  //로그인 프로필 설정
  const profile = document.getElementById("profile");
  const dropdown = document.getElementById("dropdown");
  const authArea = document.getElementById("authArea");

  profile.addEventListener("click", () => {
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  });
    function logout() {
      localStorage.removeItem("currentUser");
      location.reload();
      window.location.href = "vertscreen_main.html";
    }
    window.onload = () => {
      const currentUser = localStorage.getItem("currentUser");
      if (currentUser) {
        authArea.style.display = "none";
        profile.style.display = "flex";
        document.getElementById("avatar").innerText = currentUser.charAt(0).toUpperCase();
        document.getElementById("welcomeMsg").innerText = currentUser + "님 환영합니다!";
      }
    };
    window.addEventListener("click", (e) => {
      if (!profile.contains(e.target)) {
        dropdown.style.display = "none";
      }
    });
    window.onload = () => {
    const currentUser = localStorage.getItem("currentUser");
    if (currentUser) {
      authArea.style.display = "none";
      profile.style.display = "flex";
      document.getElementById("avatar").innerText = currentUser.charAt(0).toUpperCase();
      document.getElementById("welcomeMsg").innerText = currentUser + "님 환영합니다!";
    }

    // 보호할 링크들
    const protectedLinks = [
      document.querySelector('a[href="./party-make01.html"]'), //임시
      document.querySelector('a[href="./party-detail.html"]'),
      document.querySelector('a[href="./party-main.html"]'),
      document.querySelector('a[href="./payment.html"]') 
    ];

    protectedLinks.forEach(link => {
      link.addEventListener("click", (e) => {
        if (!currentUser) {
          e.preventDefault(); // 기본 이동 막기
          alert("로그인이 필요합니다.");
          window.location.href = "login.html"; // 로그인 페이지로 이동
        }
      });
    });
  };

    if (partyData) {
      // 지도 표시
      const map = new naver.maps.Map('detail-map', {
        center: new naver.maps.LatLng(partyData.lat, partyData.lng),
        zoom: 17
      });
      new naver.maps.Marker({
        position: new naver.maps.LatLng(partyData.lat, partyData.lng),
        map: map
      });

      let totalAmount = partyData.amount;       // 광고판 가격(총 지불해야할 금액)
      let headcount = partyData.headcount;      //  인원수(1/n 선택시)
      let perAmount = Math.floor(totalAmount / headcount);  // 광고판 가격, 인원수 (1/n 일때)
      let freeAmount = partyData.freeamount;
      freeAmount = parseInt(freeAmount);

      // 결제 완료 인원/금액
      let paidCount = partyData.paidParticipants ? partyData.paidParticipants.length : 0; // 결제 완료 인원
      let paidAmount = perAmount * paidCount;   // 결제 완료 금액
      let remainAmount = totalAmount - paidAmount;
      let progress = Math.min(100, Math.round((paidAmount / totalAmount) * 100));

      // 정보 표시
      document.getElementById("detail-map-img").src = partyData.mapImg;
      document.getElementById("detail-poster").textContent = "광고판명 : " + partyData.poster;
      document.getElementById("detail-text").textContent = "설명 : " + partyData.text;
      document.getElementById("detail-amount").textContent = "가격 : " + partyData.amount.toLocaleString() + " 원";
      document.getElementById("detail-date").textContent = "선택한 날짜 : " + partyData.date + " ~ (한달간)";
      document.getElementById("detail-headcount").textContent = "참여 가능 인원 수 : " + partyData.headcount;
      document.getElementById("detail-peramount").textContent = "1인당 예상 결제 금액 : " + partyData.perAmount;
      document.getElementById("detail-upload-img").src = partyData.uploadImg;
      document.getElementById("detail-title").textContent = "제목 : " + partyData.title;
      document.getElementById("detail-content").textContent = "내용 : " + partyData.content;
    }

    if (partyData) {
      // 기본 데이터
      let totalAmount = partyData.amount; // 광고판 금액
      let headcount = partyData.headcount; // 모집 인원(1 / n)
      let perAmount = Math.floor(totalAmount / headcount);
      let paidCount = partyData.participants ? partyData.participants.length : 0; // 결제된 인원 수
      let paidAmount = paidCount * perAmount; // 결제 완료 금액
      let remainAmount = totalAmount - paidAmount; // 남은 금액
      let remainCount = headcount - paidCount; // 남은 인원 (1 / n)
      let progress = Math.min(100, Math.round((paidAmount / totalAmount) * 100));
      console.log(progress);
      // 진행률 바 업데이트
      document.getElementById("progress-fill").style.width = progress + "%";
      document.getElementById("progress-text").textContent = progress + "%";
      document.getElementById("remain-text").textContent = `남은 금액: ${remainAmount.toLocaleString()} 원`;
      // HTML 표시
      let paymentDiv = document.getElementById("payment-status");
        paymentDiv.innerHTML = `
        <p>총 광고판 금액 : ${totalAmount.toLocaleString()} 원</p>
        <p>참여 완료 인원 : ${paidCount} 명</p>
        <p>남은 인원 수 : ${remainCount} 명</p>
        <p>1인당 결제 금액 : ${perAmount.toLocaleString()} 원</p>
        <p>현재까지 결제 완료 금액 : ${paidAmount.toLocaleString()} 원</p>
        <p>남은 금액 : ${remainAmount.toLocaleString()} 원</p>
      `;
    }

    // 파티 참가
    function joinParty() {
    let partyData = JSON.parse(localStorage.getItem("partyData"));
    let currentUser = localStorage.getItem("currentUser");

    if (!currentUser) {
      alert("로그인이 필요합니다.");
      window.location.href = "login.html";
      return;
    }

    // participants 배열 초기화
    if (!partyData.participants) {
      partyData.participants = [];
    }

    if (!partyData.participants.includes(currentUser)) {
      partyData.participants.push(currentUser);
      localStorage.setItem("partyData", JSON.stringify(partyData));
      alert("참여 신청 완료! 결제 페이지로 이동합니다.");
      window.location.href = "payment.html"; // 결제 페이지로 이동
    } else {
      alert("이미 참여 신청을 했습니다!");
    }
  }
  </script>
</body>
</html>
