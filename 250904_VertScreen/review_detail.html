<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ë¦¬ë·° ìƒì„¸ - VertScreen</title>
  <link rel="stylesheet" href="./VertScreen_mainStyle.css" />
  <style>
    main {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px
    }

    .review-header {
      margin-bottom: 20px;
      border-bottom: 1px solid var(--line);
      padding-bottom: 10px
    }

    .review-content {
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.6
    }

    .review-form textarea {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      margin-bottom: 10px;
      resize: vertical;
      background: var(--panel);
      color: var(--text)
    }

    .review-form button {
      background: var(--accent);
      color: #000;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-weight: bold;
      cursor: pointer;
      border: none
    }

    .review-form button:hover:enabled {
      background: var(--accent-2)
    }

    .review-form button:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    .stars {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      cursor: pointer
    }

    .star {
      font-size: 24px;
      color: #ccc;
      transition: color .2s
    }

    .star.selected {
      color: gold
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 20px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden
    }

    th,
    td {
      border-bottom: 1px solid var(--line);
      padding: 10px;
      text-align: left;
      background: #1a2235
    }

    th {
      background: var(--panel);
      font-weight: bold
    }

    /* ê²Œì‹œíŒ ì´ˆê¸°í™” ë²„íŠ¼ (í‘¸í„° êµ¬ì„) */
    #resetBtn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 6px 12px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 12px;
      opacity: .7;
      transition: opacity .3s;
      z-index: 1000
    }

    #resetBtn:hover {
      opacity: 1
    }

    /* í…Œì´ë¸” ë²„íŠ¼ ì˜ì—­ */
    .table-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 8px
    }

    /* í…Œì´ë¸” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .table-buttons button {
      padding: 6px 12px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      opacity: .85;
      transition: all .3s ease
    }

    .table-buttons button:hover {
      opacity: 1;
      background: var(--accent-2)
    }

    .table-buttons button:active {
      transform: scale(.95)
    }

    /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
    .upload-area {
      margin-bottom: 15px
    }

    .upload-box {
      display: inline-block;
      padding: 10px 15px;
      background: #22314b;
      color: #fff;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background .2s
    }

    .upload-box:hover {
      background: #1da1f2;
      color: #000
    }

    .preview img {
      max-width: 150px;
      margin-top: 10px;
      border-radius: 8px
    }

    .hint {
      font-size: 12px;
      color: #9aa6b2;
      margin-top: 6px
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="nav-wrap">
      <div class="brand"><img src="./VertScreen_logo.png" alt="VertScreen_logo" /></div>
      <div class="spacer"></div>
      <div class="actions"><a href="review.html" class="btn">ëª©ë¡ìœ¼ë¡œ</a></div>
    </div>
  </header>

  <main>
    <div class="review-header">
      <h2 id="reviewTitle">ë¦¬ë·° ìƒì„¸</h2>
    </div>
    <div class="review-content" id="reviewContent">ì´ íŒŒí‹°ì— ëŒ€í•œ ë¦¬ë·° ìƒì„¸ í˜ì´ì§€ì…ë‹ˆë‹¤.</div>

    <!-- ë¦¬ë·° ëª©ë¡ -->
    <div class="review-list" id="reviewList">
      <table>
        <thead>
          <tr>
            <th>ë³„ì </th>
            <th>ì´ë¯¸ì§€</th>
            <th>âœ&ensp; ë¦¬ë·° ë‚´ìš©</th>
          </tr>
        </thead>
        <tbody id="reviewTableBody"></tbody>
      </table>
      <div class="table-buttons">
        <button id="loadMoreBtn" style="display:none;">ë”ë³´ê¸°</button>
        <button id="collapseBtn" style="display:none;">ì¶•ì†Œ</button>
      </div>
    </div>

    <!-- ë¦¬ë·° ì‘ì„± -->
    <div class="review-form" id="reviewFormSection">
      <h3>ë¦¬ë·° ì‘ì„±</h3>

      <!-- ğŸ”¹ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <div class="upload-area">
        <label for="reviewImage" class="upload-box"><span>ì´ë¯¸ì§€ ì—…ë¡œë“œ</span></label>
        <input type="file" id="reviewImage" accept="image/*" style="display:none" />
        <div id="preview" class="preview"></div>
        <div class="hint">â€» ì €ì¥ê³µê°„ ë³´í˜¸ë¥¼ ìœ„í•´ ì´ë¯¸ì§€ëŠ” ìë™ìœ¼ë¡œ ì¶•ì†ŒÂ·ì••ì¶•ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>

      <!-- ë³„ì  -->
      <div class="stars" id="starContainer"></div>
      <textarea id="reviewText" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <!-- type="button" ëª…ì‹œ â†’ í˜¹ì‹œ form íƒœê·¸ê°€ ì¶”ê°€ë¼ë„ submit ë˜ì§€ ì•Šë„ë¡ -->
      <button id="saveBtn" type="button" onclick="saveReview()">ë“±ë¡</button>
    </div>

    <footer>
      <p><strong>Project A P M</strong></p>
      <p>ëŒ€í‘œì ì±„í¬ìˆ˜</p>
      <p>ì´ë©”ì¼ dooly123@naver.com</p>
      <p>ì—°ë½ì²˜ 010 1234 5678</p>
    </footer>

    <!-- ê²Œì‹œíŒ ì´ˆê¸°í™” ë²„íŠ¼ -->
    <button id="resetBtn" style="display:none;">ê²Œì‹œíŒ ì´ˆê¸°í™”</button>

    <script>
      let uploadedImage = ""; // âœ… ì—…ë¡œë“œëœ ì´ë¯¸ì§€(ì••ì¶•ëœ dataURL) ì €ì¥ ë³€ìˆ˜
      const saveBtn = document.getElementById("saveBtn");
      const fileInput = document.getElementById("reviewImage");
      const preview = document.getElementById("preview");

      /* ---------------- ì´ë¯¸ì§€ ì²˜ë¦¬ ê´€ë ¨ í•¨ìˆ˜ ---------------- */

      // íŒŒì¼ì„ ì½ì–´ì„œ <img> ê°ì²´ë¡œ ë³€í™˜
      function loadImageFromFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = reader.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // ì´ë¯¸ì§€ ì¶•ì†Œ/ì••ì¶• (ê¸°ë³¸: 800px, JPEG í’ˆì§ˆ 0.7)
      function downscale(img, maxW = 800, maxH = 800) {
        let { width, height } = img;
        const ratio = Math.min(maxW / width, maxH / height, 1);
        const w = Math.round(width * ratio);
        const h = Math.round(height * ratio);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        // JPEGë¡œ ë³€í™˜ (ìš©ëŸ‰ ì ˆê°). íˆ¬ëª… ë°°ê²½ì´ í•„ìš”í•˜ë©´ 'image/png'ë¡œ ê°€ëŠ¥
        return canvas.toDataURL("image/jpeg", 0.7);
      }

      // ìµœì¢…ì ìœ¼ë¡œ ì••ì¶•ëœ DataURL ë°˜í™˜
      async function compressFileToDataURL(file) {
        const img = await loadImageFromFile(file);
        return downscale(img, 800, 800);
      }

      /* ---------------- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ---------------- */
      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) {
          removeImage();
          return;
        }

        // ì—…ë¡œë“œ ì¤‘ì—ëŠ” ë“±ë¡ ë²„íŠ¼ ë¹„í™œì„±í™”
        saveBtn.disabled = true;
        preview.innerHTML = '<span class="hint">ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...</span>';

        try {
          // ì´ë¯¸ì§€ ì¶•ì†Œ/ì••ì¶• â†’ DataURL ì €ì¥
          const dataURL = await compressFileToDataURL(file);
          uploadedImage = dataURL;

          // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ + ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
          preview.innerHTML = `
          <div style="display:inline-flex; align-items:center; gap:5px;">
            <img src="${uploadedImage}" alt="ë¯¸ë¦¬ë³´ê¸°" />
            <button type="button" onclick="removeImage()" style="background:none;border:none;color:white;cursor:pointer;font-size:18px">Ã—</button>
          </div>`;
        } catch (err) {
          console.error(err);
          uploadedImage = "";
          preview.innerHTML = "";
          fileInput.value = "";
          alert("ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.");
        } finally {
          saveBtn.disabled = false; // ì™„ë£Œë˜ë©´ ë‹¤ì‹œ í™œì„±í™”
        }
      });

      // ì´ë¯¸ì§€ ì œê±° ë²„íŠ¼ ë™ì‘
      function removeImage() {
        uploadedImage = "";
        preview.innerHTML = "";
        fileInput.value = "";
      }

      /* ---------------- ë³„ì  UI ---------------- */
      const starContainer = document.getElementById("starContainer");
      let selectedRating = 0;
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("span");
        star.className = "star";
        star.innerHTML = "â˜…";
        star.onclick = () => {
          selectedRating = i;
          document.querySelectorAll(".star").forEach((s, idx) => {
            s.classList.toggle("selected", idx < i);
          });
        };
        starContainer.appendChild(star);
      }

      /* ---------------- ë¦¬ë·° ëª©ë¡/í˜ì´ì§• ---------------- */
      const params = new URLSearchParams(window.location.search);
      const partyName = params.get("party");
      const reviewTableBody = document.getElementById("reviewTableBody");

      let loadedCount = 0;
      const LOAD_BATCH = 5; // í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¬ ë¦¬ë·° ê°œìˆ˜
      let sortedReviews = [];

      function loadReviews() {
        const reviews = JSON.parse(localStorage.getItem("reviews") || "[]");
        sortedReviews = reviews
          .filter(r => r.party === partyName)
          .sort((a, b) => b.timestamp - a.timestamp);

        reviewTableBody.innerHTML = "";
        loadedCount = 0;
        loadMore();
      }

      function loadMore() {
        const slice = sortedReviews.slice(loadedCount, loadedCount + LOAD_BATCH);
        slice.forEach(r => {
          const tr = document.createElement("tr");

          // â­ ë³„ì 
          const tdRating = document.createElement("td");
          tdRating.textContent = "â­".repeat(r.rating);

          // ğŸ–¼ ì´ë¯¸ì§€
          const tdImage = document.createElement("td");
          if (r.image) {
            tdImage.innerHTML = `<img src="${r.image}" style="max-width:100px;border-radius:6px" />`;
          } else {
            tdImage.textContent = "-";
          }

          // âœ ë¦¬ë·° ë‚´ìš©
          const tdContent = document.createElement("td");
          tdContent.textContent = r.content;

          tr.appendChild(tdRating);
          tr.appendChild(tdImage);
          tr.appendChild(tdContent);
          reviewTableBody.appendChild(tr);
        });

        loadedCount += slice.length;
        document.getElementById("loadMoreBtn").style.display =
          loadedCount < sortedReviews.length ? "inline-block" : "none";
        document.getElementById("collapseBtn").style.display =
          loadedCount > LOAD_BATCH ? "inline-block" : "none";
      }

      /* ---------------- ë¦¬ë·° ì €ì¥ ---------------- */
      function saveReview() {
        const text = document.getElementById("reviewText").value.trim();
        if (!text) {
          alert("ë¦¬ë·°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        if (selectedRating === 0) {
          alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!confirm("ë¦¬ë·°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        const newReview = {
          party: partyName,
          content: text,
          rating: selectedRating,
          image: uploadedImage || null,
          timestamp: Date.now()
        };

        // localStorage ì €ì¥ (ìš©ëŸ‰ ì´ˆê³¼ ëŒ€ë¹„)
        try {
          const reviews = JSON.parse(localStorage.getItem("reviews") || "[]");
          reviews.push(newReview);
          localStorage.setItem("reviews", JSON.stringify(reviews));
        } catch (err) {
          console.error(err);
          if (err && (err.name === "QuotaExceededError" || err.code === 22)) {
            alert("ì €ì¥ê³µê°„ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ë” ì¤„ì´ê±°ë‚˜, ê¸°ì¡´ ë¦¬ë·° ì´ë¯¸ì§€ë¥¼ ì‚­ì œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          } else {
            alert("ë¦¬ë·° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          }
          return;
        }

        alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

        // ì…ë ¥ê°’ ì´ˆê¸°í™”
        document.getElementById("reviewText").value = "";
        selectedRating = 0;
        uploadedImage = "";
        preview.innerHTML = "";
        fileInput.value = "";
        document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));

        loadReviews();
      }

      /* ---------------- ë²„íŠ¼ ì´ë²¤íŠ¸ ---------------- */
      document.getElementById("loadMoreBtn").addEventListener("click", loadMore);
      document.getElementById("collapseBtn").addEventListener("click", loadReviews);

      // ê²Œì‹œíŒ ì´ˆê¸°í™” ë²„íŠ¼
      document.getElementById("resetBtn").addEventListener("click", () => {
        if (confirm("ì´ íŒŒí‹°ì˜ ë¦¬ë·°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          let reviews = JSON.parse(localStorage.getItem("reviews") || "[]");
          reviews = reviews.filter(r => r.party !== partyName);
          localStorage.setItem("reviews", JSON.stringify(reviews));
          loadReviews();
          alert("ë¦¬ë·° ê²Œì‹œíŒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      });

      /* ---------------- ì´ˆê¸° ì‹¤í–‰ ---------------- */
      window.onload = () => {
        loadReviews();

        // âœ… ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
        const currentUser = localStorage.getItem("currentUser");
        const reviewFormSection = document.getElementById("reviewFormSection");
        const resetBtn = document.getElementById("resetBtn");

        if (!currentUser) {
          // ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° ë¦¬ë·° ì‘ì„± ìˆ¨ê¹€
          reviewFormSection.style.display = "none";
          resetBtn.style.display = "none";
          const msg = document.createElement("p");
          msg.innerText = "ë¦¬ë·° ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.";
          msg.style.color = "gray";
          msg.style.textAlign = "center";
          reviewFormSection.parentNode.insertBefore(msg, reviewFormSection);
        } else {
          // ë¡œê·¸ì¸ ëœ ê²½ìš° ë²„íŠ¼ í‘œì‹œ
          resetBtn.style.display = "block";
        }
      };
    </script>
  </main>
</body>

</html>
